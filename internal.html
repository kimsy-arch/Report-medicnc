
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTERNAL - Report Manager PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background-color: #f1f5f9; }
        .debug-log-area { max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; background: #0f172a; color: #10b981; padding: 1rem; border-radius: 1rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.41.0",
        "react": "https://esm.sh/react@^19.2.4",
        "react-dom/client": "https://esm.sh/react-dom@^19.2.4/client",
        "recharts": "https://esm.sh/recharts@^3.7.0",
        "lucide-react": "https://esm.sh/lucide-react@^0.574.0",
        "xlsx": "https://esm.sh/xlsx@0.18.5"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="module">
        const BUILD_VERSION = "2024.03.24.V1_INTERNAL_OPS";
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            BarChart3, Upload, Archive, Play, Terminal, ChevronDown, ChevronUp,
            TrendingUp, MousePointer2, Target, Loader2, Sparkles, Database, ShieldCheck
        } from 'lucide-react';
        import * as XLSX from 'xlsx';
        import { GoogleGenAI } from "@google/genai";

        const InternalApp = () => {
            const [logs, setLogs] = useState([]);
            const [showDebug, setShowDebug] = useState(false);
            const [excelFile, setExcelFile] = useState(null);
            const [clientKey, setClientKey] = useState("snow");
            const [isParsing, setIsParsing] = useState(false);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [aiInsight, setAiInsight] = useState("");
            const [reportData, setReportData] = useState({ summary: { advertiser: "-", totalImpressions: 0, totalClicks: 0, avgCtr: 0 }, rows: [] });

            const addLog = (tag) => {
                const time = new Date().toLocaleTimeString();
                setLogs(prev => [`[${time}] ${tag}`, ...prev].slice(0, 30));
                console.log(`[${BUILD_VERSION}] ${tag}`);
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setExcelFile(file);
                    addLog("UPLOAD_CLICK: " + file.name);
                }
            };

            const runAnalysis = async () => {
                if (!excelFile) return alert("엑셀 파일을 먼저 업로드하세요.");
                setIsParsing(true);
                addLog("ANALYZE_START");
                
                try {
                    const ab = await excelFile.arrayBuffer();
                    const wb = XLSX.read(ab, { type: 'array' });
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const aoa = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    let hIdx = aoa.findIndex(r => r.join('|').includes('노출') && r.join('|').includes('클릭'));
                    if(hIdx === -1) throw new Error("헤더를 찾을 수 없습니다.");
                    
                    const rows = aoa.slice(hIdx + 1).filter(r => r[0]).map((r, i) => {
                        const imp = Number(String(r[3] || 0).replace(/,/g, ''));
                        const clk = Number(String(r[4] || 0).replace(/,/g, ''));
                        return {
                            no: i+1,
                            product: String(r[1] || '배너'),
                            date: String(r[2] || '-'),
                            impressions: imp,
                            clicks: clk,
                            ctr: imp > 0 ? Number(((clk / imp) * 100).toFixed(2)) : 0
                        };
                    });

                    const summary = {
                        name: "광고 성과 리포트",
                        advertiser: clientKey.toUpperCase(),
                        totalImpressions: rows.reduce((s, r) => s + r.impressions, 0),
                        totalClicks: rows.reduce((s, r) => s + r.clicks, 0),
                    };
                    summary.avgCtr = summary.totalImpressions > 0 ? Number(((summary.totalClicks / summary.totalImpressions) * 100).toFixed(2)) : 0;

                    setReportData({ summary, rows });
                    addLog("XLSX_PARSED: " + rows.length + " rows.");

                    setIsAnalyzing(true);
                    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                    const res = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: `다음 데이터를 분석해 마케팅 인사이트를 한국어 2문장으로 작성해줘: 광고주 ${summary.advertiser}, 노출 ${summary.totalImpressions}, 클릭 ${summary.totalClicks}, CTR ${summary.avgCtr}%.`,
                    });
                    setAiInsight(res.text || "");
                    setIsAnalyzing(false);
                    addLog("ANALYZE_DONE");
                } catch (e) {
                    addLog("ERROR: " + e.message);
                    alert(e.message);
                } finally {
                    setIsParsing(false);
                }
            };

            const exportPackage = async () => {
                if (!clientKey) return alert("Client ID를 입력하세요.");
                addLog("EXPORT_ZIP_CLICK");
                const zip = new window.JSZip();
                const dataFolder = zip.folder("data");
                const clientFolder = dataFolder.folder(clientKey);

                const monthMap = {};
                reportData.rows.forEach(row => {
                    const match = row.date.match(/\d{4}[\.\-](\d{2})/) || ["", "01"];
                    const m = match[1];
                    if(!monthMap[m]) monthMap[m] = [];
                    monthMap[m].push(row);
                });

                const monthsList = Object.keys(monthMap).sort().map(m => ({
                    label: `2026-${m}`,
                    file: `${m}.json`
                }));

                const indexJson = {
                    summary: reportData.summary,
                    aiInsight: aiInsight,
                    months: monthsList,
                    version: BUILD_VERSION
                };

                clientFolder.file("index.json", JSON.stringify(indexJson, null, 2));
                Object.keys(monthMap).forEach(m => {
                    clientFolder.file(`${m}.json`, JSON.stringify(monthMap[m], null, 2));
                });

                const content = await zip.generateAsync({ type: "blob" });
                const url = URL.createObjectURL(content);
                const a = document.createElement("a");
                a.href = url;
                a.download = `data_package_${clientKey}.zip`;
                a.click();
                addLog("ZIP_READY");
            };

            return (
                <div className="min-h-screen">
                    <header className="sticky top-0 z-50 bg-white border-b border-slate-200 px-8 py-5 flex justify-between items-center shadow-sm">
                        <div className="flex items-center space-x-3">
                            <ShieldCheck className="text-indigo-600" size={28} />
                            <h1 className="font-black text-slate-900 tracking-tighter text-xl uppercase">Internal Report OPS</h1>
                        </div>
                        <div className="flex items-center space-x-4">
                            <div className="text-right">
                                <p className="text-[10px] font-black text-slate-400 uppercase leading-none">Build Version</p>
                                <p className="text-xs font-mono font-bold text-slate-600">{BUILD_VERSION}</p>
                            </div>
                            <span className="px-4 py-1.5 bg-indigo-600 text-white text-[10px] font-black rounded-full uppercase tracking-widest shadow-lg shadow-indigo-100">Administrator</span>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-10 space-y-10">
                        {/* Control Center */}
                        <section className="bg-white rounded-[3rem] border border-slate-200 shadow-2xl overflow-hidden transition-all hover:shadow-indigo-100">
                            <div className="bg-slate-900 text-white px-10 py-5 flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <Database size={18} className="text-indigo-400" />
                                    <h2 className="text-sm font-black uppercase tracking-widest">Client Distribution Panel</h2>
                                </div>
                                <span className="text-[10px] font-mono text-slate-500">SYSTEM_READY</span>
                            </div>
                            <div className="p-10 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 items-end">
                                <div className="space-y-2">
                                    <label className="text-[11px] font-black text-slate-400 uppercase ml-1">Client Key (URL ID)</label>
                                    <input 
                                        type="text" 
                                        value={clientKey} 
                                        onChange={(e) => setClientKey(e.target.value)}
                                        className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 text-sm font-bold focus:ring-4 ring-indigo-500/10 outline-none transition-all focus:border-indigo-300" 
                                        placeholder="snow"
                                    />
                                </div>
                                <label className="cursor-pointer bg-slate-50 border-2 border-dashed border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 transition-all rounded-2xl px-5 py-4 flex items-center justify-center gap-2 text-slate-500 font-bold text-sm">
                                    <Upload size={20} /> {excelFile ? excelFile.name : "엑셀 업로드(.xlsx)"}
                                    <input type="file" className="hidden" accept=".xlsx" onChange={handleFileUpload} />
                                </label>
                                <button onClick={runAnalysis} disabled={isParsing || !excelFile} className="bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 text-white rounded-2xl px-5 py-4 flex items-center justify-center gap-2 font-black text-sm shadow-xl shadow-indigo-200 transition-all active:scale-95">
                                    {isParsing ? <Loader2 size={20} className="animate-spin" /> : <Play size={20} />} 분석 및 AI 실행
                                </button>
                                <button onClick={exportPackage} disabled={reportData.rows.length === 0} className="bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 text-white rounded-2xl px-5 py-4 flex items-center justify-center gap-2 font-black text-sm shadow-xl shadow-emerald-200 transition-all active:scale-95">
                                    <Archive size={20} /> 거래처 패키지(.zip) 내보내기
                                </button>
                            </div>
                        </section>

                        {/* Summary View */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div className="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm">
                                <p className="text-[11px] font-black text-slate-400 uppercase mb-2">Total Impressions</p>
                                <h3 className="text-3xl font-black text-indigo-600">{reportData.summary.totalImpressions.toLocaleString()}</h3>
                            </div>
                            <div className="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm">
                                <p className="text-[11px] font-black text-slate-400 uppercase mb-2">Total Clicks</p>
                                <h3 className="text-3xl font-black text-purple-600">{reportData.summary.totalClicks.toLocaleString()}</h3>
                            </div>
                            <div className="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm">
                                <p className="text-[11px] font-black text-slate-400 uppercase mb-2">Performance CTR</p>
                                <h3 className="text-3xl font-black text-emerald-600">{reportData.summary.avgCtr}%</h3>
                            </div>
                        </div>

                        {/* AI Section Preview */}
                        {aiInsight && (
                            <div className="bg-white rounded-[2.5rem] p-10 border border-indigo-100 shadow-sm relative overflow-hidden flex items-start gap-6">
                                <div className="p-4 bg-indigo-600 rounded-2xl text-white shadow-lg"><Sparkles size={24} /></div>
                                <div>
                                    <h4 className="text-[11px] font-black text-indigo-600 uppercase mb-2 tracking-widest">AI Generated Insight</h4>
                                    <p className="text-lg font-bold text-slate-700 leading-relaxed italic">"{aiInsight}"</p>
                                </div>
                            </div>
                        )}

                        {/* Debug Console */}
                        <section className="bg-slate-900 rounded-[2.5rem] overflow-hidden shadow-2xl">
                            <button onClick={() => setShowDebug(!showDebug)} className="w-full px-10 py-5 flex items-center justify-between text-slate-400 hover:text-white transition-colors">
                                <div className="flex items-center gap-3 text-[11px] font-black uppercase tracking-widest">
                                    <Terminal size={16} /> Operations Log Monitor
                                </div>
                                {showDebug ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                            </button>
                            {showDebug && (
                                <div className="px-10 pb-10">
                                    <div className="debug-log-area no-scrollbar">
                                        {logs.map((log, i) => <div key={i} className="mb-1 leading-relaxed">{log}</div>)}
                                        {logs.length === 0 && <div className="opacity-30">No system events recorded.</div>}
                                    </div>
                                </div>
                            )}
                        </section>
                    </main>
                    <footer className="text-center py-12 text-slate-300 text-[11px] font-black uppercase tracking-widest border-t border-slate-200">Ad Tech Operations Platform © 2024</footer>
                </div>
            );
        };
        createRoot(document.getElementById('root')).render(<InternalApp />);
    </script>
</body>
</html>
